<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>TEQRA OS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="bg-overlay"></div>

    <div class="app-container">
        <header>
            <div class="brand-box">
                <h1 class="logo">TEQRA<span class="dot">.</span>STORE</h1>
            </div>
            <button id="admin-toggle" class="cyber-btn-small" style="display: none;" onclick="toggleAdminPanel()">
                <i class="fas fa-terminal"></i> CMD
            </button>
        </header>

        <div id="admin-panel" class="control-panel">
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('add')">–î–û–î–ê–¢–ò</button>
                <button class="tab-btn" onclick="switchTab('orders')">–ó–ê–ú–û–í–õ–ï–ù–ù–Ø</button>
            </div>

            <div id="tab-add" class="tab-content active">
                <div class="control-grid">
                    <div class="input-group full-width"><label>–ú–æ–¥–µ–ª—å</label><input type="text" id="inp-title"></div>
                    <div class="input-group"><label>–¶—ñ–Ω–∞ ‚Ç¥</label><input type="number" id="inp-price"></div>
                    <div class="input-group">
                        <select id="inp-type">
                            <option value="gaming">GAMING</option>
                            <option value="work">BUSINESS</option>
                            <option value="ultrabook">ULTRA</option>
                        </select>
                    </div>
                    <div class="input-group full-width"><label>–ó–∞–ª—ñ–∑–æ</label><input type="text" id="inp-specs"></div>
                    
                    <div class="input-group full-width">
                        <input type="file" id="inp-file" accept="image/*" style="display: none;">
                        <button class="cyber-btn-glitch" onclick="document.getElementById('inp-file').click()">
                            <i class="fas fa-camera"></i> –û–ë–†–ê–¢–ò –§–û–¢–û
                        </button>
                        <div id="upload-status" class="status-msg"></div>
                        <input type="hidden" id="inp-img-url">
                    </div>
                </div>
                <button class="cyber-btn-glitch" id="add-btn" onclick="addProduct()" disabled>–ê–ö–¢–ò–í–£–í–ê–¢–ò</button>
            </div>

            <div id="tab-orders" class="tab-content">
                <div id="orders-list" class="orders-container"></div>
            </div>
        </div>

        <div id="order-form" class="order-overlay" style="display:none;">
            <div class="order-card fade-in">
                <div id="order-step-1">
                    <h3>–û–§–û–†–ú–õ–ï–ù–ù–Ø</h3>
                    <div class="delivery-inputs">
                        <input type="text" id="order-fio" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ —Ç–∞ –Ü–º'—è">
                        <input type="tel" id="order-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É">
                        <input type="text" id="order-city" placeholder="–ú—ñ—Å—Ç–æ">
                        <input type="text" id="order-address" placeholder="–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ø–æ—à—Ç–∏">
                    </div>

                    <label>–ú–ï–ù–ï–î–ñ–ï–†:</label>
                    <div class="selector-row">
                        <button class="sel-btn active" id="btn-rina" onclick="setManager('Rina')">RINA</button>
                        <button class="sel-btn" id="btn-misha" onclick="setManager('Misha')">MISHA</button>
                    </div>

                    <button class="cyber-btn-glitch" onclick="confirmOrder()">–ü–Ü–î–¢–í–ï–†–î–ò–¢–ò</button>
                    <button class="close-txt" onclick="closeOrder()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                </div>

                <div id="order-success" style="display:none;">
                    <i class="fas fa-check-circle success-icon"></i>
                    <h2 class="neon-txt">–ü–†–ò–ô–ù–Ø–¢–û!</h2>
                    <p>–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–∫–æ—Ä–æ –∑–≤‚Äô—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.</p>
                    <button class="cyber-btn-small" style="width:100%" onclick="closeOrder()">–ó–†–û–ó–£–ú–Ü–õ–û</button>
                </div>
            </div>
        </div>

        <div id="catalog" class="grid-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuYjKFAsKbdu_PLI4OkxiW6Wz-Yhq_q44",
            databaseURL: "https://catalog-b9cc2-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "catalog-b9cc2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const productsRef = ref(db, 'laptops');
        const ordersRef = ref(db, 'orders');

        const admins = [7255848995, 921509542];
        const tg = window.Telegram.WebApp;
        const IMGBB_KEY = "70bb1de10d70f62410bc55ddd2a4fd0e";

        let currentOrder = { title: '', manager: 'Rina' };

        // –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ß–ï–†–ï–ó IMGBB
        document.getElementById('inp-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('upload-status').innerText = "‚è≥ –í–∞–Ω—Ç–∞–∂–∏–º–æ...";
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: formData });
                const result = await res.json();
                document.getElementById('inp-img-url').value = result.data.url;
                document.getElementById('upload-status').innerText = "‚úÖ –ì–æ—Ç–æ–≤–æ";
                document.getElementById('add-btn').disabled = false;
            } catch (err) { tg.showAlert("–ü–æ–º–∏–ª–∫–∞ —Ñ–æ—Ç–æ"); }
        });

        window.confirmOrder = async () => {
            const fio = document.getElementById('order-fio').value;
            const phone = document.getElementById('order-phone').value;
            const city = document.getElementById('order-city').value;
            const addr = document.getElementById('order-address').value;

            if(!fio || !phone) return tg.showAlert("–í–∫–∞–∂—ñ—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–∏!");

            await push(ordersRef, {
                ...currentOrder,
                client: fio, phone: phone, addr: `${city}, ${addr}`,
                user: tg.initDataUnsafe?.user?.username || 'user',
                date: new Date().toLocaleString()
            });

            document.getElementById('order-step-1').style.display = 'none';
            document.getElementById('order-success').style.display = 'block';
            tg.HapticFeedback.notificationOccurred('success');
        };

        // –ö–ï–†–£–í–ê–ù–ù–Ø
        window.toggleAdminPanel = () => document.getElementById('admin-panel').classList.toggle('open');
        window.switchTab = (t) => {
            document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${t}')"]`).classList.add('active');
            document.getElementById(`tab-${t}`).classList.add('active');
        };

        onValue(productsRef, (s) => {
            const catalog = document.getElementById('catalog');
            catalog.innerHTML = "";
            const data = s.val();
            if(data) Object.keys(data).reverse().forEach(k => {
                const p = data[k];
                catalog.innerHTML += `<div class="cyber-card"><div class="card-img-box"><img src="${p.image}"></div><div class="card-body"><h3>${p.title}</h3><div class="action-row"><span>${p.price} ‚Ç¥</span><button class="buy-btn" onclick="openOrder('${p.title}')">–ö–£–ü–ò–¢–ò</button></div></div></div>`;
            });
        });

        onValue(ordersRef, (s) => {
            const list = document.getElementById('orders-list');
            list.innerHTML = "";
            const data = s.val();
            if(data) Object.keys(data).reverse().forEach(k => {
                const o = data[k];
                list.innerHTML += `<div class="order-item"><b>${o.title}</b><br>üë§ ${o.client}<br>üìû ${o.phone}<br>üìç ${o.addr}<br>üë®‚Äçüíº –ú–µ–Ω–µ–¥–∂–µ—Ä: ${o.manager}<br><button class="del-order" onclick="remove(ref(db, 'orders/${k}'))">–ì–û–¢–û–í–û</button></div>`;
            });
        });

        window.openOrder = (t) => { currentOrder.title = t; document.getElementById('order-form').style.display = 'flex'; };
        window.closeOrder = () => document.getElementById('order-form').style.display = 'none';
        window.setManager = (m) => { currentOrder.manager = m; document.getElementById('btn-rina').classList.toggle('active', m==='Rina'); document.getElementById('btn-misha').classList.toggle('active', m==='Misha'); };

        if (admins.includes(tg.initDataUnsafe?.user?.id)) document.getElementById('admin-toggle').style.display = 'flex';
    </script>
</body>
</html>

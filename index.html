<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TEQRA Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <header>
        <h1 class="logo">TEQRA</h1>
        <p class="subtitle">Laptop Store & Service</p>
    </header>

    <div class="filters-container">
        <select id="filter-type" class="filter-select" onchange="renderProducts()">
            <option value="all">üíª –í—Å—ñ –Ω–æ—É—Ç–±—É–∫–∏</option>
            <option value="gaming">üéÆ –Ü–≥—Ä–æ–≤—ñ (Gaming)</option>
            <option value="work">üíº –†–æ–±–æ—Ç–∞ (Office)</option>
            <option value="ultrabook">‚úàÔ∏è –£–ª—å—Ç—Ä–∞–±—É–∫–∏</option>
        </select>
        <select id="filter-price" class="filter-select" onchange="renderProducts()">
            <option value="all">üí∞ –ë—É–¥—å-—è–∫–∞ —Ü—ñ–Ω–∞</option>
            <option value="cheap">–î–æ 10 000 –≥—Ä–Ω</option>
            <option value="mid">10 - 20 000 –≥—Ä–Ω</option>
            <option value="expensive">–í—ñ–¥ 20 000 –≥—Ä–Ω</option>
        </select>
    </div>

    <div id="catalog" class="catalog-grid">
        <div class="loading">
            <i class="fas fa-circle-notch fa-spin"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–∑–∏ TEQRA...
        </div>
    </div>

    <div id="admin-panel" style="display: none;">
        <button class="fab-btn" onclick="openAddModal()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–¥–∞—Ç–∏ –Ω–æ—É—Ç–±—É–∫</h2>
                <span class="close-btn" onclick="closeAddModal()">&times;</span>
            </div>
            
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞ –º–æ–¥–µ–ª—ñ</label>
                <input type="text" id="inp-title" placeholder="–ù–∞–ø—Ä: MSI GF63 Thin">
            </div>
            
            <div class="form-group">
                <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                <select id="inp-type">
                    <option value="gaming">üéÆ –Ü–≥—Ä–æ–≤–∏–π</option>
                    <option value="work">üíº –û—Ñ—ñ—Å–Ω–∏–π</option>
                    <option value="ultrabook">‚úàÔ∏è –£–ª—å—Ç—Ä–∞–±—É–∫</option>
                </select>
            </div>

            <div class="form-group">
                <label>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–ü—Ä–æ—Ü–µ—Å–æ—Ä, –í—ñ–¥—è—Ö–∞)</label>
                <input type="text" id="inp-specs" placeholder="i7-8750H / GTX 1060 / 16GB">
            </div>

            <div class="form-group">
                <label>–¶—ñ–Ω–∞ (–≥—Ä–Ω)</label>
                <input type="number" id="inp-price" placeholder="18999">
            </div>
            
            <div class="form-group">
                <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ</label>
                <input type="text" id="inp-img" placeholder="https://...">
                <small style="color:#888; font-size:10px;">–°–∫–æ–ø—ñ—é–π –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ –∑ Telegram</small>
            </div>

            <button class="btn-primary" onclick="addProduct()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –±–∞–∑—É</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // === –¢–í–û–ô –ö–û–ù–§–ò–ì (–£–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω) ===
        const firebaseConfig = {
            apiKey: "AIzaSyCuYjKFAsKbdu_PLI4OkxiW6Wz-Yhq_q44",
            authDomain: "catalog-b9cc2.firebaseapp.com",
            databaseURL: "https://catalog-b9cc2-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "catalog-b9cc2",
            storageBucket: "catalog-b9cc2.firebasestorage.app",
            messagingSenderId: "653019820107",
            appId: "1:653019820107:web:ee51e7187c0ea8ccfbddce"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const productsRef = ref(db, 'laptops');

        // === –í–ê–®–ò ID (–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —É –≤–∞—Å) ===
        const admins = [
            7255848995, // –¢—ã
            921509542   // –ú–∏—à–∞
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
        const tg = window.Telegram.WebApp;
        tg.expand(); 

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ê–¥–º–∏–Ω–∞
        function checkAdmin() {
            const userId = tg.initDataUnsafe?.user?.id;
            // –ï—Å–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ –∞–¥–º–∏–Ω–æ–≤
            if (admins.includes(userId)) {
                document.getElementById('admin-panel').style.display = 'block';
            }
        }
        checkAdmin();

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        let allProducts = [];
        
        onValue(productsRef, (snapshot) => {
            const data = snapshot.val();
            const catalog = document.getElementById('catalog');
            catalog.innerHTML = "";
            allProducts = [];

            if (!data) {
                catalog.innerHTML = '<div class="empty-state">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤...</div>';
                return;
            }

            Object.keys(data).forEach(key => {
                allProducts.push({ id: key, ...data[key] });
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
            allProducts.reverse();
            renderProducts();
        });

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
        window.renderProducts = function() {
            const catalog = document.getElementById('catalog');
            const typeFilter = document.getElementById('filter-type').value;
            const priceFilter = document.getElementById('filter-price').value;
            
            catalog.innerHTML = "";

            const filtered = allProducts.filter(p => {
                let matchType = (typeFilter === 'all') || (p.type === typeFilter);
                let matchPrice = true;
                const price = parseInt(p.price);
                
                if (priceFilter === 'cheap') matchPrice = price < 10000;
                if (priceFilter === 'mid') matchPrice = price >= 10000 && price <= 20000;
                if (priceFilter === 'expensive') matchPrice = price > 20000;

                return matchType && matchPrice;
            });

            if(filtered.length === 0) {
                catalog.innerHTML = '<div class="empty-state">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üòî</div>';
                return;
            }

            filtered.forEach(p => {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å –±–µ–π–¥–∂–∞
                let badgeClass = 'badge-work';
                let badgeText = 'Office';
                if(p.type === 'gaming') { badgeClass = 'badge-game'; badgeText = 'Gaming'; }
                if(p.type === 'ultrabook') { badgeClass = 'badge-ultra'; badgeText = 'Ultra'; }

                const card = document.createElement('div');
                card.className = 'product-card fade-in';
                card.innerHTML = `
                    <div class="card-image-container">
                        <img src="${p.image || 'https://via.placeholder.com/300'}" class="product-img" onerror="this.src='https://via.placeholder.com/300?text=TEQRA'">
                        <span class="badge ${badgeClass}">${badgeText}</span>
                        ${admins.includes(tg.initDataUnsafe?.user?.id) ? 
                        `<button class="delete-btn" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                    <div class="card-info">
                        <h3 class="product-title">${p.title}</h3>
                        <p class="product-specs">${p.specs}</p>
                        <div class="price-row">
                            <span class="price">${p.price} ‚Ç¥</span>
                            <button class="buy-btn" onclick="tg.sendData('–•–æ—á—É –∫—É–ø–∏—Ç–∏: ${p.title}')">–ö—É–ø–∏—Ç–∏</button>
                        </div>
                    </div>
                `;
                catalog.appendChild(card);
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ (–¥–ª—è –ê–¥–º–∏–Ω–æ–≤)
        window.addProduct = async function() {
            const title = document.getElementById('inp-title').value;
            const specs = document.getElementById('inp-specs').value;
            const price = document.getElementById('inp-price').value;
            const type = document.getElementById('inp-type').value;
            const img = document.getElementById('inp-img').value;

            if(!title || !price) {
                tg.showAlert("‚ö†Ô∏è –í–∫–∞–∂—ñ—Ç—å —Ö–æ—á–∞ –± –Ω–∞–∑–≤—É —Ç–∞ —Ü—ñ–Ω—É!");
                return;
            }

            try {
                await push(productsRef, {
                    title, specs, price, type, image: img,
                    date: Date.now()
                });
                closeAddModal();
                document.querySelectorAll('input').forEach(i => i.value = '');
                tg.showAlert("‚úÖ –£—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!");
            } catch (e) {
                tg.showAlert("–ü–æ–º–∏–ª–∫–∞: " + e.message);
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ
        window.deleteProduct = async function(id) {
            tg.showConfirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –Ω–æ—É—Ç–±—É–∫ –∑ –±–∞–∑–∏?", async (ok) => {
                if(ok) {
                    const itemRef = ref(db, `laptops/${id}`);
                    await remove(itemRef);
                }
            });
        }

        window.openAddModal = () => document.getElementById('add-modal').style.display = 'flex';
        window.closeAddModal = () => document.getElementById('add-modal').style.display = 'none';
        window.renderProducts = renderProducts;
    </script>
</body>
</html>
